openapi: 3.0.3
info:
  title: Apple OAuth2 Backend API
  description: |
    ## üçé Sign in with Apple - Backend API
    
    –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Apple OAuth2.
    
    ### –û—Å–Ω–æ–≤–Ω–æ–π flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
    
    1. `GET /auth/apple/login` - –ü–æ–ª—É—á–∏—Ç—å URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ Apple
    2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Apple
    3. `POST /auth/apple/callback` - Apple —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç —Å—é–¥–∞ —Å –∫–æ–¥–æ–º
    4. `GET /auth/user` - –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ session_id
    5. `POST /auth/logout` - –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    
    ### –í–∞–∂–Ω–æ:
    
    - Email –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è Apple **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
    - –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Ö–æ–¥–∞—Ö –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ `user_id` (sub claim)
    - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ production
    
  version: 1.0.0
  contact:
    name: Apple Developer Documentation
    url: https://developer.apple.com/documentation/sign_in_with_apple

servers:
  - url: https://web-production-dbb4d.up.railway.app
    description: Production (Railway)
  - url: http://localhost:8000
    description: Local Development

tags:
  - name: auth
    description: Endpoints –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Apple OAuth2
  - name: debug
    description: –¢–µ—Å—Ç–æ–≤—ã–µ endpoints –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

paths:
  /:
    get:
      summary: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± API
      description: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö endpoints –∏ –≤–µ—Ä—Å–∏—é API
      operationId: getRoot
      responses:
        '200':
          description: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiInfo'
              example:
                message: "Apple OAuth2 Backend API"
                version: "1.0.0"
                endpoints:
                  login: "/auth/apple/login"
                  callback: "/auth/apple/callback"
                  user: "/auth/user"
                  logout: "/auth/logout"

  /auth/apple/login:
    get:
      tags:
        - auth
      summary: –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      description: |
        ## –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞—Ü–∏—è OAuth flow
        
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Apple.
        
        ### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
        1. –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç–æ—Ç endpoint
        2. –ü–æ–ª—É—á–∏—Ç–µ `auth_url` –∏–∑ –æ—Ç–≤–µ—Ç–∞
        3. –†–µ–¥–∏—Ä–µ–∫—Ç–Ω–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `auth_url`
        4. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Apple –≤–µ—Ä–Ω—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `/auth/apple/callback`
        
        ### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ Apple:
        - `client_id` - –≤–∞—à Services ID
        - `redirect_uri` - callback URL
        - `response_type` - –≤—Å–µ–≥–¥–∞ "code"
        - `response_mode` - "form_post"
        - `state` - CSRF —Ç–æ–∫–µ–Ω
        - `scope` - "name email"
      operationId: appleLogin
      responses:
        '200':
          description: URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ Apple
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUrlResponse'
              example:
                auth_url: "https://appleid.apple.com/auth/authorize?client_id=com.example.app&redirect_uri=https://example.com/callback&response_type=code&response_mode=form_post&state=abc123&scope=name+email"
                message: "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ auth_url –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"

  /auth/apple/callback:
    post:
      tags:
        - auth
      summary: Callback –æ—Ç Apple
      description: |
        ## –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç Apple
        
        Apple —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç —Å—é–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        ### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç Apple (form data):
        - `code` - Authorization code –¥–ª—è –æ–±–º–µ–Ω–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã
        - `state` - CSRF —Ç–æ–∫–µ–Ω (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º)
        - `user` - JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!)
        - `error` - –û—à–∏–±–∫–∞, –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å
        
        ### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:
        1. –ü—Ä–æ–≤–µ—Ä–∫–∞ state (–∑–∞—â–∏—Ç–∞ –æ—Ç CSRF)
        2. –û–±–º–µ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω—ã —á–µ—Ä–µ–∑ Apple Token API
        3. –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ id_token
        4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        5. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ frontend —Å session_id
        
        ### –í–∞–∂–Ω–æ:
        - –ò–º—è –∏ email –¥–æ—Å—Ç—É–ø–Ω—ã **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
      operationId: appleCallback
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                code:
                  type: string
                  description: Authorization code –æ—Ç Apple
                state:
                  type: string
                  description: CSRF —Ç–æ–∫–µ–Ω
                user:
                  type: string
                  description: JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
                error:
                  type: string
                  description: –û—à–∏–±–∫–∞ –æ—Ç Apple (–µ—Å–ª–∏ –µ—Å—Ç—å)
              required:
                - code
                - state
      responses:
        '302':
          description: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ frontend
          headers:
            Location:
              description: URL —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å session_id –∏–ª–∏ error
              schema:
                type: string
                example: "http://localhost:3000/callback?session_id=abc123"
        '400':
          description: –ù–µ–≤–µ—Ä–Ω—ã–π state –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/user:
    get:
      tags:
        - auth
      summary: –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      description: |
        ## –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ session_id.
        
        ### –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –ø–æ–ª—è:
        - `user_id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –æ—Ç Apple (claim "sub")
        - `email` - Email (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º relay)
        - `email_verified` - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ email
        - `is_private_email` - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π email Apple
      operationId: getUser
      parameters:
        - name: session_id
          in: query
          required: true
          description: ID —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          schema:
            type: string
          example: "uX9ommxzitzwGomr4uWUVr8Gg971rgvmU9DvDF9nVeA"
      responses:
        '200':
          description: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
              example:
                user_id: "001234.abcdef1234567890abcdef.1234"
                email: "user@privaterelay.appleid.com"
                email_verified: true
                is_private_email: true
        '401':
          description: –ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∞—è —Å–µ—Å—Å–∏—è
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∞—è —Å–µ—Å—Å–∏—è"

  /auth/logout:
    post:
      tags:
        - auth
      summary: –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
      description: |
        ## –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        
        –£–¥–∞–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
      operationId: logout
      parameters:
        - name: session_id
          in: query
          required: true
          description: ID —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          schema:
            type: string
      responses:
        '200':
          description: –£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
              example:
                message: "–£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"

  /auth/test-config:
    get:
      tags:
        - debug
      summary: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      description: |
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–±–µ–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞).
        
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
      operationId: testConfig
      responses:
        '200':
          description: –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
              example:
                team_id: "AB12CD34EF"
                client_id: "com.example.app.service"
                key_id: "XY98ZW76VU"
                redirect_uri: "https://example.com/auth/apple/callback"
                private_key_loaded: "YES"
                private_key_starts_with: "-----BEGIN PRIVATE KEY-----..."

  /auth/test-jwt:
    get:
      tags:
        - debug
      summary: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é JWT
      description: |
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π JWT client_secret.
        
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
      operationId: testJwt
      responses:
        '200':
          description: JWT —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwtTestResponse'
              example:
                status: "success"
                client_secret: "eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IlhZOThaTzc2VlUifQ..."
                message: "JWT —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
        '500':
          description: –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JWT
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    ApiInfo:
      type: object
      properties:
        message:
          type: string
        version:
          type: string
        endpoints:
          type: object
          additionalProperties:
            type: string

    AuthUrlResponse:
      type: object
      required:
        - auth_url
        - message
      properties:
        auth_url:
          type: string
          description: URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Apple
        message:
          type: string
          description: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    UserResponse:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          description: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç Apple (sub claim)
        email:
          type: string
          nullable: true
          description: Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º relay)
        email_verified:
          type: boolean
          nullable: true
          description: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ email
        is_private_email:
          type: boolean
          nullable: true
          description: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π email Apple

    LogoutResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏

    ConfigResponse:
      type: object
      properties:
        team_id:
          type: string
          description: Apple Team ID
        client_id:
          type: string
          description: Apple Services ID (Client ID)
        key_id:
          type: string
          description: Apple Key ID
        redirect_uri:
          type: string
          description: Callback URL
        private_key_loaded:
          type: string
          description: –ó–∞–≥—Ä—É–∂–µ–Ω –ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
        private_key_starts_with:
          type: string
          description: –ù–∞—á–∞–ª–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)

    JwtTestResponse:
      type: object
      properties:
        status:
          type: string
        client_secret:
          type: string
          description: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JWT —Ç–æ–∫–µ–Ω
        message:
          type: string

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏

